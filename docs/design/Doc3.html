<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');.lst-kix_uh9wen2wuq2x-8>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-3.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-3 0}.lst-kix_uh9wen2wuq2x-6>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-3>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-7>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-4>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-5>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-0>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-1>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-6>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-7>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-2>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-4>li:before{content:"-  "}.lst-kix_uh9wen2wuq2x-5>li:before{content:"-  "}ol.lst-kix_2h72aqp5ihn2-6.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-6 0}.lst-kix_uh9wen2wuq2x-3>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-8>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-0>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-0,decimal) ". "}.lst-kix_2h72aqp5ihn2-1>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-1,lower-latin) ") "}.lst-kix_yq1m7twlsmi-4>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-4}.lst-kix_2h72aqp5ihn2-2>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-2,lower-roman) ") "}ul.lst-kix_tydg66k0pc47-4{list-style-type:none}ul.lst-kix_tydg66k0pc47-5{list-style-type:none}ul.lst-kix_tydg66k0pc47-2{list-style-type:none}.lst-kix_2h72aqp5ihn2-0>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-0}ul.lst-kix_tydg66k0pc47-3{list-style-type:none}ul.lst-kix_tydg66k0pc47-0{list-style-type:none}ul.lst-kix_tydg66k0pc47-1{list-style-type:none}ul.lst-kix_tydg66k0pc47-8{list-style-type:none}ul.lst-kix_tydg66k0pc47-6{list-style-type:none}ul.lst-kix_tydg66k0pc47-7{list-style-type:none}.lst-kix_yq1m7twlsmi-8>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-8}ol.lst-kix_2h72aqp5ihn2-1.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-1 0}.lst-kix_dpaoqrre9zs1-2>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-0>li:before{content:"-  "}.lst-kix_dpaoqrre9zs1-1>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-0>li:before{content:"-  "}.lst-kix_t19fyvg3to46-0>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-4>li:before{content:"-  "}.lst-kix_t19fyvg3to46-2>li:before{content:"-  "}.lst-kix_t19fyvg3to46-4>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-2>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-8>li:before{content:"-  "}.lst-kix_t19fyvg3to46-6>li:before{content:"-  "}.lst-kix_t19fyvg3to46-8>li:before{content:"-  "}.lst-kix_yq1m7twlsmi-0>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-0}.lst-kix_yn51mvm2vdo4-1>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-6>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-3>li:before{content:"-  "}.lst-kix_ln80o93high-1>li:before{content:"-  "}.lst-kix_yq1m7twlsmi-1>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-1}.lst-kix_yn51mvm2vdo4-5>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-7>li:before{content:"-  "}ul.lst-kix_6oytfjqr8tn-8{list-style-type:none}.lst-kix_8h7z344qy58t-7>li:before{content:"-  "}ul.lst-kix_6oytfjqr8tn-0{list-style-type:none}ul.lst-kix_6oytfjqr8tn-1{list-style-type:none}ul.lst-kix_6oytfjqr8tn-2{list-style-type:none}ul.lst-kix_6oytfjqr8tn-3{list-style-type:none}ul.lst-kix_6oytfjqr8tn-4{list-style-type:none}ul.lst-kix_6oytfjqr8tn-5{list-style-type:none}ul.lst-kix_6oytfjqr8tn-6{list-style-type:none}ul.lst-kix_6oytfjqr8tn-7{list-style-type:none}.lst-kix_z4whsx5ofu7s-8>li:before{content:"-  "}.lst-kix_z4whsx5ofu7s-6>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-6>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-6,decimal) ". "}.lst-kix_2h72aqp5ihn2-4>li:before{content:"(" counter(lst-ctn-kix_2h72aqp5ihn2-4,lower-latin) ") "}.lst-kix_ln80o93high-3>li:before{content:"-  "}.lst-kix_yq1m7twlsmi-7>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-7}ol.lst-kix_yq1m7twlsmi-8.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-8 0}ol.lst-kix_2h72aqp5ihn2-4.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-4 0}.lst-kix_ln80o93high-5>li:before{content:"-  "}.lst-kix_ln80o93high-7>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-8>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-8,lower-roman) ". "}.lst-kix_z4whsx5ofu7s-2>li:before{content:"-  "}.lst-kix_z4whsx5ofu7s-0>li:before{content:"-  "}.lst-kix_z4whsx5ofu7s-4>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-4>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-4}ul.lst-kix_6sugoa1ohdob-4{list-style-type:none}ul.lst-kix_6sugoa1ohdob-3{list-style-type:none}ul.lst-kix_6sugoa1ohdob-6{list-style-type:none}ul.lst-kix_6sugoa1ohdob-5{list-style-type:none}ul.lst-kix_6sugoa1ohdob-8{list-style-type:none}ul.lst-kix_6sugoa1ohdob-7{list-style-type:none}ol.lst-kix_yq1m7twlsmi-0.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-0 0}ul.lst-kix_6sugoa1ohdob-0{list-style-type:none}ul.lst-kix_6sugoa1ohdob-2{list-style-type:none}ul.lst-kix_6sugoa1ohdob-1{list-style-type:none}ul.lst-kix_8h7z344qy58t-4{list-style-type:none}ul.lst-kix_8h7z344qy58t-5{list-style-type:none}ul.lst-kix_8h7z344qy58t-6{list-style-type:none}ul.lst-kix_8h7z344qy58t-7{list-style-type:none}.lst-kix_1le1fo9nbrio-4>li:before{content:"-  "}ul.lst-kix_8h7z344qy58t-0{list-style-type:none}ul.lst-kix_8h7z344qy58t-1{list-style-type:none}.lst-kix_o16uaa5gb2ko-6>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-7>li:before{content:"-  "}ul.lst-kix_8h7z344qy58t-2{list-style-type:none}ul.lst-kix_8h7z344qy58t-3{list-style-type:none}.lst-kix_1le1fo9nbrio-0>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-8>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-1>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-2>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-3>li:before{content:"-  "}ul.lst-kix_8h7z344qy58t-8{list-style-type:none}.lst-kix_1le1fo9nbrio-5>li:before{content:"-  "}ul.lst-kix_o16uaa5gb2ko-7{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-6{list-style-type:none}.lst-kix_hzx6v4vyl3t3-2>li:before{content:"-  "}ul.lst-kix_o16uaa5gb2ko-8{list-style-type:none}.lst-kix_hzx6v4vyl3t3-3>li:before{content:"-  "}ul.lst-kix_o16uaa5gb2ko-3{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-2{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-5{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-4{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-1{list-style-type:none}ul.lst-kix_o16uaa5gb2ko-0{list-style-type:none}.lst-kix_2h72aqp5ihn2-3>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-3}.lst-kix_8h7z344qy58t-6>li:before{content:"-  "}ol.lst-kix_2h72aqp5ihn2-8.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-8 0}.lst-kix_hzx6v4vyl3t3-7>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-5.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-5 0}.lst-kix_hzx6v4vyl3t3-6>li:before{content:"-  "}.lst-kix_8h7z344qy58t-3>li:before{content:"-  "}.lst-kix_67iftjb76j7c-7>li:before{content:"-  "}.lst-kix_8h7z344qy58t-2>li:before{content:"-  "}.lst-kix_67iftjb76j7c-6>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-6.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-6 0}.lst-kix_67iftjb76j7c-3>li:before{content:"-  "}.lst-kix_67iftjb76j7c-2>li:before{content:"-  "}.lst-kix_yq1m7twlsmi-5>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-5}.lst-kix_6oytfjqr8tn-1>li:before{content:"-  "}.lst-kix_t19fyvg3to46-3>li:before{content:"-  "}ul.lst-kix_kx6407feq4dj-0{list-style-type:none}ul.lst-kix_kx6407feq4dj-2{list-style-type:none}ul.lst-kix_kx6407feq4dj-1{list-style-type:none}ul.lst-kix_kx6407feq4dj-4{list-style-type:none}ul.lst-kix_kx6407feq4dj-3{list-style-type:none}ul.lst-kix_kx6407feq4dj-6{list-style-type:none}ul.lst-kix_kx6407feq4dj-5{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-0{list-style-type:none}.lst-kix_t19fyvg3to46-7>li:before{content:"-  "}ul.lst-kix_yn51mvm2vdo4-6{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-5{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-4{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-3{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-2{list-style-type:none}.lst-kix_2h72aqp5ihn2-6>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-6}ul.lst-kix_yn51mvm2vdo4-1{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-0{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-8{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-7{list-style-type:none}.lst-kix_6oytfjqr8tn-5>li:before{content:"-  "}ul.lst-kix_b3ln0i4qqvys-6{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-5{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-4{list-style-type:none}.lst-kix_yn51mvm2vdo4-2>li:before{content:"-  "}ul.lst-kix_b3ln0i4qqvys-3{list-style-type:none}.lst-kix_vu1v9uz4f5lh-8>li:before{content:"-  "}ul.lst-kix_b3ln0i4qqvys-2{list-style-type:none}.lst-kix_tydg66k0pc47-6>li:before{content:"-  "}ul.lst-kix_yn51mvm2vdo4-8{list-style-type:none}ul.lst-kix_b3ln0i4qqvys-1{list-style-type:none}ul.lst-kix_yn51mvm2vdo4-7{list-style-type:none}.lst-kix_2h72aqp5ihn2-8>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-8}.lst-kix_6sugoa1ohdob-1>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-6>li:before{content:"-  "}.lst-kix_vu1v9uz4f5lh-4>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-5>li:before{content:"-  "}.lst-kix_vu1v9uz4f5lh-0>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-4.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-4 0}.lst-kix_z4whsx5ofu7s-7>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-1.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-1 0}.lst-kix_yq1m7twlsmi-3>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-3}.lst-kix_yq1m7twlsmi-1>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-1,lower-latin) ". "}.lst-kix_yq1m7twlsmi-5>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-5,lower-roman) ". "}.lst-kix_2h72aqp5ihn2-5>li:before{content:"(" counter(lst-ctn-kix_2h72aqp5ihn2-5,lower-roman) ") "}.lst-kix_ln80o93high-2>li:before{content:"-  "}.lst-kix_6sugoa1ohdob-5>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-2.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-2 0}.lst-kix_ln80o93high-6>li:before{content:"-  "}.lst-kix_z4whsx5ofu7s-3>li:before{content:"-  "}.lst-kix_n7kl983wr31y-1>li:before{content:"-  "}.lst-kix_n7kl983wr31y-5>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-1>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-1}.lst-kix_kx6407feq4dj-5>li:before{content:"-  "}.lst-kix_kx6407feq4dj-7>li:before{content:"-  "}.lst-kix_qs7x4xzbk39h-2>li:before{content:"-  "}.lst-kix_kx6407feq4dj-4>li:before{content:"-  "}.lst-kix_kx6407feq4dj-8>li:before{content:"-  "}ol.lst-kix_2h72aqp5ihn2-0.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-0 0}.lst-kix_kx6407feq4dj-1>li:before{content:"-  "}.lst-kix_kx6407feq4dj-3>li:before{content:"-  "}.lst-kix_qs7x4xzbk39h-1>li:before{content:"-  "}ul.lst-kix_1x8bhayrb2l2-8{list-style-type:none}.lst-kix_yq1m7twlsmi-6>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-6}.lst-kix_qs7x4xzbk39h-0>li:before{content:"-  "}.lst-kix_kx6407feq4dj-2>li:before{content:"-  "}ul.lst-kix_qs7x4xzbk39h-1{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-2{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-0{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-5{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-6{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-3{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-4{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-7{list-style-type:none}ul.lst-kix_qs7x4xzbk39h-8{list-style-type:none}.lst-kix_kx6407feq4dj-6>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-2>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-2}.lst-kix_qs7x4xzbk39h-8>li:before{content:"-  "}.lst-kix_qs7x4xzbk39h-7>li:before{content:"-  "}ul.lst-kix_1x8bhayrb2l2-5{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-4{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-7{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-6{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-1{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-0{list-style-type:none}.lst-kix_qs7x4xzbk39h-6>li:before{content:"-  "}ul.lst-kix_1x8bhayrb2l2-3{list-style-type:none}ul.lst-kix_1x8bhayrb2l2-2{list-style-type:none}.lst-kix_qs7x4xzbk39h-3>li:before{content:"-  "}.lst-kix_qs7x4xzbk39h-5>li:before{content:"-  "}.lst-kix_qs7x4xzbk39h-4>li:before{content:"-  "}ul.lst-kix_vu1v9uz4f5lh-4{list-style-type:none}.lst-kix_1x8bhayrb2l2-5>li:before{content:"-  "}ul.lst-kix_vu1v9uz4f5lh-5{list-style-type:none}ul.lst-kix_vu1v9uz4f5lh-6{list-style-type:none}.lst-kix_2i3uwu8w4jdx-0>li:before{content:"-  "}ul.lst-kix_vu1v9uz4f5lh-7{list-style-type:none}ul.lst-kix_vu1v9uz4f5lh-8{list-style-type:none}.lst-kix_2i3uwu8w4jdx-1>li:before{content:"-  "}.lst-kix_1x8bhayrb2l2-3>li:before{content:"-  "}.lst-kix_1x8bhayrb2l2-7>li:before{content:"-  "}.lst-kix_1x8bhayrb2l2-4>li:before{content:"-  "}.lst-kix_1x8bhayrb2l2-8>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-3>li:before{content:"-  "}.lst-kix_1x8bhayrb2l2-1>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-2>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-4>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-7>li:before{content:"-  "}ul.lst-kix_vu1v9uz4f5lh-0{list-style-type:none}ul.lst-kix_vu1v9uz4f5lh-1{list-style-type:none}ul.lst-kix_vu1v9uz4f5lh-2{list-style-type:none}.lst-kix_1x8bhayrb2l2-2>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-6>li:before{content:"-  "}ul.lst-kix_vu1v9uz4f5lh-3{list-style-type:none}.lst-kix_b3ln0i4qqvys-3>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-5>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-4>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-1>li:before{content:"-  "}ul.lst-kix_ln80o93high-8{list-style-type:none}.lst-kix_1x8bhayrb2l2-6>li:before{content:"-  "}.lst-kix_b3ln0i4qqvys-2>li:before{content:"-  "}ul.lst-kix_ln80o93high-6{list-style-type:none}ul.lst-kix_ln80o93high-7{list-style-type:none}ul.lst-kix_ln80o93high-4{list-style-type:none}ul.lst-kix_ln80o93high-5{list-style-type:none}.lst-kix_tydg66k0pc47-1>li:before{content:"-  "}ul.lst-kix_ln80o93high-2{list-style-type:none}ul.lst-kix_ln80o93high-3{list-style-type:none}.lst-kix_b3ln0i4qqvys-0>li:before{content:"-  "}ul.lst-kix_ln80o93high-0{list-style-type:none}ul.lst-kix_ln80o93high-1{list-style-type:none}.lst-kix_tydg66k0pc47-0>li:before{content:"-  "}.lst-kix_tydg66k0pc47-3>li:before{content:"-  "}.lst-kix_tydg66k0pc47-2>li:before{content:"-  "}ul.lst-kix_kx6407feq4dj-8{list-style-type:none}ul.lst-kix_kx6407feq4dj-7{list-style-type:none}.lst-kix_1x8bhayrb2l2-0>li:before{content:"-  "}ol.lst-kix_2h72aqp5ihn2-7.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-7 0}.lst-kix_yq1m7twlsmi-2>li{counter-increment:lst-ctn-kix_yq1m7twlsmi-2}.lst-kix_n7kl983wr31y-8>li:before{content:"-  "}.lst-kix_n7kl983wr31y-6>li:before{content:"-  "}.lst-kix_tydg66k0pc47-7>li:before{content:"-  "}.lst-kix_tydg66k0pc47-5>li:before{content:"-  "}.lst-kix_vu1v9uz4f5lh-7>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-5>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-5}.lst-kix_6sugoa1ohdob-0>li:before{content:"-  "}ul.lst-kix_uh9wen2wuq2x-8{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-6{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-7{list-style-type:none}.lst-kix_vu1v9uz4f5lh-3>li:before{content:"-  "}ul.lst-kix_uh9wen2wuq2x-4{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-5{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-8{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-2{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-7{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-3{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-6{list-style-type:none}.lst-kix_vu1v9uz4f5lh-5>li:before{content:"-  "}ul.lst-kix_uh9wen2wuq2x-0{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-5{list-style-type:none}ul.lst-kix_uh9wen2wuq2x-1{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-4{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-3{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-2{list-style-type:none}ul.lst-kix_dpaoqrre9zs1-1{list-style-type:none}.lst-kix_2i3uwu8w4jdx-6>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-8>li:before{content:"-  "}ul.lst-kix_dpaoqrre9zs1-0{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-2.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-2 0}ol.lst-kix_yq1m7twlsmi-7.start{counter-reset:lst-ctn-kix_yq1m7twlsmi-7 0}.lst-kix_vu1v9uz4f5lh-1>li:before{content:"-  "}ol.lst-kix_2h72aqp5ihn2-5.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-5 0}ol.lst-kix_2h72aqp5ihn2-8{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-7{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-6{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-5{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-4{list-style-type:none}.lst-kix_yq1m7twlsmi-6>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-6,decimal) ". "}ol.lst-kix_2h72aqp5ihn2-3{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-2{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-1{list-style-type:none}.lst-kix_yq1m7twlsmi-8>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-8,lower-roman) ". "}ol.lst-kix_2h72aqp5ihn2-0{list-style-type:none}ul.lst-kix_t19fyvg3to46-0{list-style-type:none}ul.lst-kix_t19fyvg3to46-1{list-style-type:none}ul.lst-kix_t19fyvg3to46-2{list-style-type:none}.lst-kix_yq1m7twlsmi-2>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-2,lower-roman) ". "}ul.lst-kix_t19fyvg3to46-3{list-style-type:none}ul.lst-kix_t19fyvg3to46-4{list-style-type:none}ul.lst-kix_t19fyvg3to46-5{list-style-type:none}ul.lst-kix_t19fyvg3to46-6{list-style-type:none}ul.lst-kix_t19fyvg3to46-7{list-style-type:none}ul.lst-kix_t19fyvg3to46-8{list-style-type:none}.lst-kix_yq1m7twlsmi-4>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-4,lower-latin) ". "}.lst-kix_6sugoa1ohdob-2>li:before{content:"-  "}.lst-kix_6sugoa1ohdob-4>li:before{content:"-  "}.lst-kix_6sugoa1ohdob-6>li:before{content:"-  "}.lst-kix_n7kl983wr31y-0>li:before{content:"-  "}ul.lst-kix_z4whsx5ofu7s-5{list-style-type:none}.lst-kix_n7kl983wr31y-4>li:before{content:"-  "}ul.lst-kix_z4whsx5ofu7s-4{list-style-type:none}ul.lst-kix_z4whsx5ofu7s-7{list-style-type:none}ul.lst-kix_z4whsx5ofu7s-6{list-style-type:none}.lst-kix_6sugoa1ohdob-8>li:before{content:"-  "}ul.lst-kix_z4whsx5ofu7s-8{list-style-type:none}ul.lst-kix_z4whsx5ofu7s-1{list-style-type:none}.lst-kix_n7kl983wr31y-2>li:before{content:"-  "}ul.lst-kix_z4whsx5ofu7s-0{list-style-type:none}ul.lst-kix_z4whsx5ofu7s-3{list-style-type:none}ul.lst-kix_z4whsx5ofu7s-2{list-style-type:none}ul.lst-kix_67iftjb76j7c-0{list-style-type:none}ul.lst-kix_67iftjb76j7c-1{list-style-type:none}ul.lst-kix_67iftjb76j7c-2{list-style-type:none}ul.lst-kix_67iftjb76j7c-3{list-style-type:none}ul.lst-kix_67iftjb76j7c-4{list-style-type:none}ul.lst-kix_67iftjb76j7c-5{list-style-type:none}ul.lst-kix_67iftjb76j7c-6{list-style-type:none}ul.lst-kix_67iftjb76j7c-7{list-style-type:none}ol.lst-kix_2h72aqp5ihn2-3.start{counter-reset:lst-ctn-kix_2h72aqp5ihn2-3 0}ul.lst-kix_67iftjb76j7c-8{list-style-type:none}.lst-kix_o16uaa5gb2ko-8>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-6>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-3>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-7>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-4>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-5>li:before{content:"-  "}.lst-kix_1le1fo9nbrio-2>li:before{content:"-  "}.lst-kix_yq1m7twlsmi-0>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-0,decimal) ". "}.lst-kix_o16uaa5gb2ko-0>li:before{content:"-  "}.lst-kix_o16uaa5gb2ko-1>li:before{content:"-  "}.lst-kix_hzx6v4vyl3t3-1>li:before{content:"-  "}ul.lst-kix_hzx6v4vyl3t3-5{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-4{list-style-type:none}.lst-kix_hzx6v4vyl3t3-0>li:before{content:"-  "}ul.lst-kix_hzx6v4vyl3t3-3{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-2{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-8{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-7{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-6{list-style-type:none}ul.lst-kix_1le1fo9nbrio-7{list-style-type:none}ul.lst-kix_1le1fo9nbrio-6{list-style-type:none}ul.lst-kix_1le1fo9nbrio-8{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-1{list-style-type:none}ul.lst-kix_hzx6v4vyl3t3-0{list-style-type:none}.lst-kix_hzx6v4vyl3t3-8>li:before{content:"-  "}.lst-kix_8h7z344qy58t-5>li:before{content:"-  "}.lst-kix_8h7z344qy58t-4>li:before{content:"-  "}.lst-kix_hzx6v4vyl3t3-5>li:before{content:"-  "}.lst-kix_hzx6v4vyl3t3-4>li:before{content:"-  "}.lst-kix_8h7z344qy58t-1>li:before{content:"-  "}.lst-kix_67iftjb76j7c-8>li:before{content:"-  "}.lst-kix_8h7z344qy58t-0>li:before{content:"-  "}.lst-kix_67iftjb76j7c-5>li:before{content:"-  "}.lst-kix_67iftjb76j7c-4>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-2{list-style-type:none}ol.lst-kix_yq1m7twlsmi-3{list-style-type:none}ol.lst-kix_yq1m7twlsmi-4{list-style-type:none}.lst-kix_67iftjb76j7c-1>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-5{list-style-type:none}ol.lst-kix_yq1m7twlsmi-6{list-style-type:none}ol.lst-kix_yq1m7twlsmi-7{list-style-type:none}ol.lst-kix_yq1m7twlsmi-8{list-style-type:none}.lst-kix_67iftjb76j7c-0>li:before{content:"-  "}ol.lst-kix_yq1m7twlsmi-0{list-style-type:none}ol.lst-kix_yq1m7twlsmi-1{list-style-type:none}.lst-kix_t19fyvg3to46-1>li:before{content:"-  "}.lst-kix_n7kl983wr31y-7>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-3>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-0>li:before{content:"-  "}.lst-kix_t19fyvg3to46-5>li:before{content:"-  "}.lst-kix_tydg66k0pc47-8>li:before{content:"-  "}.lst-kix_tydg66k0pc47-4>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-4>li:before{content:"-  "}.lst-kix_6oytfjqr8tn-7>li:before{content:"-  "}.lst-kix_yn51mvm2vdo4-8>li:before{content:"-  "}.lst-kix_vu1v9uz4f5lh-6>li:before{content:"-  "}.lst-kix_ln80o93high-0>li:before{content:"-  "}.lst-kix_2i3uwu8w4jdx-7>li:before{content:"-  "}ul.lst-kix_1le1fo9nbrio-1{list-style-type:none}ul.lst-kix_1le1fo9nbrio-0{list-style-type:none}ul.lst-kix_1le1fo9nbrio-3{list-style-type:none}ul.lst-kix_1le1fo9nbrio-2{list-style-type:none}ul.lst-kix_1le1fo9nbrio-5{list-style-type:none}.lst-kix_b3ln0i4qqvys-8>li:before{content:"-  "}.lst-kix_8h7z344qy58t-8>li:before{content:"-  "}ul.lst-kix_1le1fo9nbrio-4{list-style-type:none}.lst-kix_vu1v9uz4f5lh-2>li:before{content:"-  "}ul.lst-kix_2i3uwu8w4jdx-4{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-3{list-style-type:none}.lst-kix_yq1m7twlsmi-7>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-7,lower-latin) ". "}ul.lst-kix_2i3uwu8w4jdx-2{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-1{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-8{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-7{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-6{list-style-type:none}ul.lst-kix_2i3uwu8w4jdx-5{list-style-type:none}.lst-kix_yq1m7twlsmi-3>li:before{content:"" counter(lst-ctn-kix_yq1m7twlsmi-3,decimal) ". "}.lst-kix_ln80o93high-4>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-3>li:before{content:"(" counter(lst-ctn-kix_2h72aqp5ihn2-3,decimal) ") "}.lst-kix_6sugoa1ohdob-3>li:before{content:"-  "}ul.lst-kix_n7kl983wr31y-1{list-style-type:none}ul.lst-kix_n7kl983wr31y-2{list-style-type:none}ul.lst-kix_n7kl983wr31y-0{list-style-type:none}ul.lst-kix_n7kl983wr31y-5{list-style-type:none}ul.lst-kix_n7kl983wr31y-6{list-style-type:none}ul.lst-kix_n7kl983wr31y-3{list-style-type:none}.lst-kix_6sugoa1ohdob-7>li:before{content:"-  "}ul.lst-kix_n7kl983wr31y-4{list-style-type:none}ul.lst-kix_n7kl983wr31y-7{list-style-type:none}.lst-kix_2h72aqp5ihn2-7>li:before{content:"" counter(lst-ctn-kix_2h72aqp5ihn2-7,lower-latin) ". "}ul.lst-kix_n7kl983wr31y-8{list-style-type:none}.lst-kix_n7kl983wr31y-3>li:before{content:"-  "}.lst-kix_ln80o93high-8>li:before{content:"-  "}ul.lst-kix_2i3uwu8w4jdx-0{list-style-type:none}.lst-kix_z4whsx5ofu7s-1>li:before{content:"-  "}.lst-kix_z4whsx5ofu7s-5>li:before{content:"-  "}.lst-kix_kx6407feq4dj-0>li:before{content:"-  "}.lst-kix_2h72aqp5ihn2-7>li{counter-increment:lst-ctn-kix_2h72aqp5ihn2-7}ol{margin:0;padding:0}table td,table th{padding:0}.c7{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f4f3ec;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c14{-webkit-text-decoration-skip:none;color:#1155cc;font-weight:400;text-decoration:underline;vertical-align:baseline;text-decoration-skip-ink:none;font-size:11pt;font-family:"Arial";font-style:normal}.c19{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c25{margin-left:18pt;padding-top:3pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c6{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c29{padding-top:14pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c31{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c16{padding-top:4pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c21{padding-top:10pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c30{padding-top:10pt;padding-bottom:4pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c26{background-color:#f4f3ec;color:#6c6b5a;font-weight:400;font-family:"Consolas"}.c10{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c4{background-color:#f4f3ec;font-family:"Consolas";color:#5f9182;font-weight:400}.c11{background-color:#f4f3ec;font-family:"Consolas";color:#7d9726;font-weight:400}.c13{background-color:#f4f3ec;font-family:"Consolas";color:#ae7313;font-weight:400}.c27{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c17{text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c5{border-spacing:0;border-collapse:collapse;margin-right:auto}.c9{background-color:#f4f3ec;font-family:"Consolas";color:#36a166;font-weight:400}.c8{background-color:#f4f3ec;font-family:"Consolas";color:#5f5e4e;font-weight:400}.c33{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c18{padding:0;margin:0}.c22{margin-left:144pt;padding-left:0pt}.c2{margin-left:36pt;padding-left:0pt}.c28{margin-left:72pt;padding-left:0pt}.c23{color:inherit;text-decoration:inherit}.c15{margin-left:108pt;padding-left:0pt}.c24{height:0pt}.c12{text-indent:36pt}.c32{height:350.2pt}.c1{height:11pt}.c20{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c33"><p class="c0"><span class="c3">Table of Contents: </span></p><p class="c16"><span class="c14"><a class="c23" href="#h.hzyo607chpf7">Introduction</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.f711cp13jn5c">HTTP Server / Services</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.jozseh3fi4h8">Database (Server Side)</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.cei893in2zwk">Models</a></span></p><p class="c25"><span class="c14"><a class="c23" href="#h.n3xz7yruzsot">Execution</a></span></p><p class="c25"><span class="c14"><a class="c23" href="#h.b9gjiifjbezj">Schedule</a></span></p><p class="c25"><span class="c14"><a class="c23" href="#h.kekk0ogycw3k">Timer</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.z01lu6uzxead">Database Access (Application Side)</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.9ndjqanaogc9">Kafka (Server Side)</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.28jpsdqcm4hz">Kafka Producer</a></span></p><p class="c21"><span class="c14"><a class="c23" href="#h.pakq7lq0h3z6">In Memory Consumer Group</a></span></p><p class="c25"><span class="c14"><a class="c23" href="#h.850ogodold1w">Consistent Hashing</a></span></p><p class="c25"><span class="c14"><a class="c23" href="#h.5vdo51qly1x4">Loading timers into memory</a></span></p><p class="c21"><span class="c27"><a class="c23" href="#h.6fel2koq3e3u">Persistence Consumer Group</a></span></p><p class="c21"><span class="c27"><a class="c23" href="#h.cu70c0z17l8">Scheduler/Executor</a></span></p><p class="c30"><span class="c27"><a class="c23" href="#h.gcfhp9fvf1yi">Summary (File Structure)</a></span></p><p class="c0 c1"><span class="c3"></span></p><h3 class="c6" id="h.hzyo607chpf7"><span class="c19">Introduction </span></h3><p class="c0 c12"><span class="c3">This document describes the implementation of a distributed recurring task executor. </span></p><p class="c0 c12"><span class="c3">The basic problem is to persist some instructions for when/how a task should be executed and make sure that one node in the cluster has those instructions in memory and is executing them. It has to handle redistributing timers when nodes join and leave, and it uses hashing to determine which nodes should get which timers under different views of membership.</span></p><p class="c0 c12"><span class="c3">The complexity comes from race conditions between persistence of timers and changes in membership. Consider some arbitrary membership protocol where nodes learn of other nodes joining the cluster at not exactly the same time. When a node gets a request to create a timer, it passes this request to whatever node should own the timer based on its view of membership via hashing and that node (it could be the same node) persists it in a database and in its own memory for execution. When a node dies or leaves the ring, recovering is as simple as rehashing based on the new view of membership and having any nodes that are now responsible for new timers grab them from the database. Here&rsquo;s a race condition that can happen:</span></p><ul class="c18 lst-kix_1x8bhayrb2l2-0 start"><li class="c0 c2"><span class="c3">Node A is alone in the Cluster</span></li><li class="c0 c2"><span class="c3">Concurrently: </span></li></ul><ul class="c18 lst-kix_2i3uwu8w4jdx-0 start"><li class="c0 c28"><span class="c3">Node A receives and persists in DB a timer that belongs to B under a view of membership including both A and B, but A doesn&rsquo;t know about B yet.</span></li><li class="c0 c28"><span class="c3">Node B joins and grabs all timers from the database that belong to it under a view of membership including A and B. </span></li></ul><ul class="c18 lst-kix_67iftjb76j7c-0 start"><li class="c0 c2"><span class="c3">Node A hears of B and removes its timer from memory because B is handling it</span></li></ul><p class="c0 c1"><span class="c3"></span></p><p class="c0 c12"><span class="c3">Now, consider those concurrent steps. They&rsquo;re concurrent because they&rsquo;re happening on different nodes and if the nodes communicated about them, they wouldn&rsquo;t be able to confidently agree on the order. They might as well be simultaneous. If they happen in the wrong order, B makes the DB request and then A persists a timer, then as soon as A hears of B and drops its timer no one will be executing that timer.</span></p><p class="c0 c12"><span>There are many solutions to this problem. One solution is to couple persistence of timers and distribution of timers based on views of membership. This is like Node B telling the database when it joins, and that way if Node A adds a timer that should belong to Node B, the database will know to pass the information along to Node B. To do this I&rsquo;ll use Kafka. There will be one topic, called &ldquo;timers,&rdquo; and any node can persist any timer through Kafka. There will be two consumer groups for &ldquo;timers,&rdquo; one for putting timers in memory for execution and one for putting timers in a separate database. The purpose of the separate database is to make certain queries that clients might be interested in much easier than they would be with Kafka.</span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">In terms of code, here are the components:</span></p><ul class="c18 lst-kix_1le1fo9nbrio-0 start"><li class="c0 c2"><span class="c3">An HTTP Server to handle client requests.</span></li><li class="c0 c2"><span class="c3">A database layer for PostgreSQL</span></li><li class="c0 c2"><span class="c3">A Scheduler for scheduling/executing recurring tasks.</span></li><li class="c0 c2"><span class="c3">A Kafka producer to create timers</span></li></ul><ul class="c18 lst-kix_1le1fo9nbrio-1 start"><li class="c0 c28"><span class="c3">Creates UUID and sends to the correct partition based on the UUID.</span></li></ul><ul class="c18 lst-kix_1le1fo9nbrio-0"><li class="c0 c2"><span class="c3">A Kafka consumer to hand timers to the SchedulerExecutor</span></li></ul><ul class="c18 lst-kix_1le1fo9nbrio-1 start"><li class="c0 c28"><span class="c3">Uses consistent hashing as a balancing strategy</span></li></ul><ul class="c18 lst-kix_1le1fo9nbrio-0"><li class="c0 c2"><span class="c3">A Kafka consumer to persist timers to the database</span></li></ul><ul class="c18 lst-kix_1le1fo9nbrio-1 start"><li class="c0 c28"><span class="c3">This should be an idempotent operation due to Kafka&rsquo;s at least once semantics</span></li></ul><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">This diagram represents the flow of a request to create a timer, starting from the HTTP server of one node, and ending in both PostgreSQL persistence and a place in memory in the Scheduler.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 460.00px; height: 505.00px;"><img alt="" src="images/image1.png" style="width: 460.00px; height: 505.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c1"><span class="c3"></span></p><h3 class="c6" id="h.f711cp13jn5c"><span class="c19">HTTP Server / Services</span></h3><p class="c0"><span class="c3">There will be the following services:</span></p><ul class="c18 lst-kix_dpaoqrre9zs1-0 start"><li class="c0 c2"><span class="c3">Create a timer</span></li><li class="c0 c2"><span class="c3">Delete a timer</span></li><li class="c0 c2"><span class="c3">Get a timer</span></li><li class="c0 c2"><span class="c3">View all timers associated with an account</span></li></ul><p class="c0 c1"><span class="c3"></span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">API endpoints</span></p><p class="c0"><span>POST /timers/:accountName</span></p><p class="c0"><span class="c3">res: {uuid, error}</span></p><p class="c0"><span class="c3">Example Body:</span></p><p class="c0"><span class="c3">{</span></p><p class="c0 c12"><span class="c3">&ldquo;execution&rdquo;: &ldquo;http&rdquo;,</span></p><p class="c0 c12"><span class="c3">&ldquo;executionConfig&rdquo; : {</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;url&rdquo; : &ldquo;http://www.example.com&rdquo;,</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;Method&rdquo;: &quot;GET&rdquo; | &ldquo;POST&rdquo;,</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;headers&rdquo; : [&ldquo;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;&rdquo;]</span></p><p class="c0 c12"><span class="c3">}</span></p><p class="c0 c12"><span class="c3">&ldquo;schedule&rdquo;: &ldquo;cron&rdquo; | &ldquo;interval&rdquo;</span></p><p class="c0 c12"><span class="c3">&ldquo;scheduleConfig&rdquo;: {</span></p><p class="c0 c12"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;cron&rdquo; : &ldquo;0 0 12 1 * *&rdquo;, // string of the form &ldquo;second minute hour day(of month) </span></p><p class="c0"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// month day(of week).&rdquo; ex: noon, the first of every month</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;executions&rdquo;: -1 &nbsp; &nbsp; &nbsp; &nbsp;// how many times to execute timer. -1 for &ldquo;until cancelled&rdquo;</span></p><p class="c0 c12"><span class="c3">},</span></p><p class="c0 c12"><span class="c3">&ldquo;accountName&rdquo; : &ldquo;Local Bakery Devops&rdquo;</span></p><p class="c0"><span class="c3">}</span></p><p class="c0"><span class="c3"><br>DELETE /timers/:accountName/:uuid</span></p><p class="c0"><span class="c3">res: { error }</span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">GET /timers/:accountName/:uuid</span></p><p class="c0"><span class="c3">Example Response:</span></p><p class="c0"><span class="c3">{</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;timer&rdquo;: { </span></p><p class="c0 c12 c20"><span class="c3">&ldquo;execution&rdquo;: &ldquo;http&rdquo;,</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;executionConfig&rdquo; : {</span></p><p class="c0 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;url&rdquo; : &ldquo;http://www.example.com&rdquo;,</span></p><p class="c0 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;Method&rdquo;: &quot;GET&rdquo; | &ldquo;POST&rdquo;,</span></p><p class="c0 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;headers&rdquo; : [&ldquo;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;&rdquo;],</span></p><p class="c0 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;body&rdquo;: &ldquo;&rdquo;</span></p><p class="c0 c12 c20"><span class="c3">},</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;schedule&rdquo;: &ldquo;interval&rdquo;</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;scheduleConfig&rdquo;: {</span></p><p class="c0 c12 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;start&rdquo;: // seconds since epoch</span></p><p class="c0 c12 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;interval&rdquo;: // interval in seconds</span></p><p class="c0 c12 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;executions&rdquo;: 10</span></p><p class="c0 c12 c20"><span class="c3">},</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;meta&rdquo;: {</span></p><p class="c0 c12 c20"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creationTime: // seconds since epoch</span></p><p class="c0 c12 c20"><span class="c3">},</span></p><p class="c0 c12 c20"><span class="c3">&ldquo;accountName&rdquo; : &ldquo;Local Bakery Devops&rdquo;,</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;error&rdquo;: null</span></p><p class="c0"><span class="c3">}</span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">GET /timers/:accountName</span></p><p class="c0"><span class="c3">Example Response:</span></p><p class="c0"><span class="c3">{</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;timers&rdquo;: [&ldquo;uuid1&rdquo;, &ldquo;uuid2&rdquo;]</span></p><p class="c0"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&ldquo;error&rdquo;: null</span></p><p class="c0"><span>}</span></p><h3 class="c6" id="h.jozseh3fi4h8"><span class="c19">Database (Server Side)</span></h3><p class="c0"><span class="c3">There will be a timer object and an account object. This is using PostgreSQL. Single-leader replication, which is the only kind provided by Postgres, will be set up. In the future if we need more write throughput, for example to update timer counts quickly, a different database can be used.</span></p><a id="t.c83bfdb70c3599877c6479086d196ea45de20de1"></a><a id="t.0"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c8">CREATE TYPE execution AS ENUM (</span><span class="c11">&#39;HTTP&#39;</span><span class="c8">);<br>CREATE TYPE schedule AS ENUM (</span><span class="c11">&#39;CRON&#39;</span><span class="c8">, </span><span class="c11">&#39;INTERVAL&#39;</span><span class="c8">);<br><br>CREATE TABLE timer (<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id uuid,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;account_name TEXT NOT NULL,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;partition INTEGER NOT NULL,<br> &nbsp; &nbsp; &nbsp;execution execution NOT NULL,<br> &nbsp; &nbsp; &nbsp;executionConfig json NOT NULL,<br> &nbsp; &nbsp; &nbsp;schedule schedule NOT NULL,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scheduleConfig json NOT NULL,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meta json NOT NULL,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIMARY KEY (account_name, id)<br>);<br><br></span><span class="c26">/* Makes queries to get all timers that belong to an account faster */</span><span class="c17 c8"><br>CREATE INDEX idx_timer_account<br>ON timer(account_name)</span></p></td></tr><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10 c1"><span class="c4 c17"></span></p></td></tr></tbody></table><h3 class="c6" id="h.cei893in2zwk"><span class="c19">Models</span></h3><p class="c0 c12"><span class="c3">So far we&rsquo;ve described the types expected of and returned by the web service. We&rsquo;ve also described the type persisted in PostgreSQL. Models will describe the types in memory that will be passed within the program. These will look exactly the same as the type persisted in PostgreSQL and the types that will be persisted in Kafka. They will also implement json.Marshaler and json.Unmarshaler.</span></p><p class="c0 c12"><span class="c3">In terms of code organization, there will be 3 packages, Timer, Execution, Schedule. In addition to the json interfaces, Execution and Schedule will provide their own interfaces for validation and executing/scheduling timers.</span></p><p class="c0 c1"><span class="c3"></span></p><h4 class="c29" id="h.n3xz7yruzsot"><span class="c31">Execution</span></h4><a id="t.64c9edce2a14f67b2c8a249682d85a27dd944450"></a><a id="t.1"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c26">// &quot;tasktimer/models/execution&quot;</span><span class="c8"><br><br></span><span class="c4">type</span><span class="c8">&nbsp;Type </span><span class="c4">string</span><span class="c8"><br></span><span class="c4">const</span><span class="c8">&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HTTP Type = </span><span class="c11">&quot;HTTP&quot;</span><span class="c8"><br>)<br><br></span><span class="c4">type</span><span class="c8">&nbsp;Method </span><span class="c4">string</span><span class="c8"><br></span><span class="c4">const</span><span class="c8">&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get Method = </span><span class="c11">&quot;GET&quot;</span><span class="c8"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post &nbsp; &nbsp; &nbsp; = </span><span class="c11">&quot;POST&quot;</span><span class="c8"><br>)<br><br></span><span class="c4">type</span><span class="c8">&nbsp;Interface </span><span class="c4">interface</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetExec() (</span><span class="c4">func</span><span class="c13">()</span><span class="c8">, </span><span class="c9">error</span><span class="c8">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">IsValid</span><span class="c13">()</span><span class="c8">&nbsp;</span><span class="c9">bool</span><span class="c8"><br>}<br><br></span><span class="c9">type</span><span class="c8">&nbsp;</span><span class="c9">HTTPConfig</span><span class="c8">&nbsp;</span><span class="c9">struct</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Url </span><span class="c4">string</span><span class="c8"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Body </span><span class="c4">string</span><span class="c8"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Headers []</span><span class="c4">string</span><span class="c8"><br>}<br><br></span><span class="c26">// implementation</span><span class="c8"><br></span><span class="c4">func</span><span class="c8">&nbsp;</span><span class="c13">(conf *HTTPConfig)</span><span class="c8">&nbsp;</span><span class="c9">GetExec</span><span class="c13">()</span><span class="c8">&nbsp;</span><span class="c9">func</span><span class="c13">()</span><span class="c8">&nbsp;{ </span><span class="c26">//...</span></p></td></tr></tbody></table><p class="c0 c1"><span class="c3"></span></p><h4 class="c29" id="h.b9gjiifjbezj"><span class="c31">Schedule</span></h4><a id="t.629101d8317d1be3b31ef8cfee532642eee1b07f"></a><a id="t.2"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c26">// &quot;tasktimer/models/schedule&quot;</span><span class="c8 c17"><br></span></p><p class="c10"><span class="c4">type</span><span class="c8">&nbsp;Type </span><span class="c4">string</span><span class="c8"><br></span><span class="c4">const</span><span class="c8">&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HTTP Type = </span><span class="c11">&quot;HTTP&quot;</span><span class="c8"><br>)<br></span><span class="c4">type</span><span class="c8">&nbsp;Interface </span><span class="c4">interface</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetSchedFunc() </span><span class="c4">func</span><span class="c13">()</span><span class="c8">&nbsp;</span><span class="c9">time</span><span class="c8">.</span><span class="c9">Timer</span><span class="c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">IsValid</span><span class="c13">()</span><span class="c8">&nbsp;</span><span class="c9">bool</span><span class="c8"><br>}<br><br></span><span class="c9">type</span><span class="c8">&nbsp;</span><span class="c9">CronConfig</span><span class="c8">&nbsp;</span><span class="c9">struct</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cron </span><span class="c4">string</span><span class="c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Executions </span><span class="c4">int</span><span class="c8"><br>}<br><br></span><span class="c4">type</span><span class="c8">&nbsp;IntervalConfig {<br> &nbsp; &nbsp; &nbsp;Start time.Time<br> &nbsp; &nbsp; &nbsp;Interval time.Duration<br> &nbsp; &nbsp; &nbsp;Executions </span><span class="c4">int</span><span class="c8"><br>}<br></span><span class="c26">// implementations ...</span></p></td></tr></tbody></table><p class="c0 c1"><span class="c3"></span></p><h4 class="c29" id="h.kekk0ogycw3k"><span class="c31">Timer</span></h4><a id="t.7e683bef1b205a9eb870838c0017197acbef85c8"></a><a id="t.3"></a><table class="c5"><tbody><tr class="c32"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c26">// &quot;tasktimer/models/timer&quot;</span><span class="c8"><br></span><span class="c4">import</span><span class="c8">&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c11">&quot;uuid&quot;</span><span class="c8"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c11">&quot;github.com/nivista/tasktimer/model/execution&quot;</span><span class="c8"><br> &nbsp; &nbsp; &nbsp;</span><span class="c11">&quot;github.com/nivista/tasktimer/model/schedule&quot;</span><span class="c8"><br>)<br><br></span><span class="c4">type</span><span class="c8">&nbsp;Timer </span><span class="c4">struct</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Id uuid.UUID,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Account </span><span class="c4">string</span><span class="c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Partition </span><span class="c4">int</span><span class="c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExecutionCount </span><span class="c4">int</span><span class="c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution </span><span class="c4">string</span><span class="c17 c8">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExecutionConfig execution.Interface,</span></p><p class="c10"><span class="c8">&nbsp; &nbsp; &nbsp; Schedule string,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScheduleConfig schedule.Interface,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Meta<br>} <br></span><span class="c4">type</span><span class="c8">&nbsp;Meta </span><span class="c4">struct</span><span class="c17 c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CreationTime time.Time<br>}</span></p></td></tr><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c26 c17">func (t *Timer) MarshalJSON() []byte, error {</span></p><p class="c10"><span class="c17 c26">// &hellip; implementations </span></p></td></tr></tbody></table><h3 class="c6" id="h.z01lu6uzxead"><span class="c19">Database Access (Application Side)</span></h3><p class="c0"><span class="c3">The lib/pq driver and golang&rsquo;s sql interface will be used. The operations that need to be done are:</span></p><ul class="c18 lst-kix_uh9wen2wuq2x-0 start"><li class="c0 c2"><span class="c3">Insert timer</span></li><li class="c0 c2"><span class="c3">Delete timer</span></li><li class="c0 c2"><span class="c3">Get timer</span></li><li class="c0 c2"><span class="c3">Get timers by account</span></li><li class="c0 c2"><span class="c3">Increment timer count</span></li></ul><p class="c0"><span class="c3">InitDB will be called initializing a global DB object that initializes the DataAccess interface.</span></p><p class="c0 c1"><span class="c3"></span></p><a id="t.924b6f03f81ccb5b3ff15213ccac01cefdd98a94"></a><a id="t.4"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c4">type</span><span class="c8">&nbsp;DataAccess </span><span class="c4">interface</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InsertTimer(Timer t) error<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteTimer(account </span><span class="c4">string</span><span class="c8">, id uuid.UUID) error <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetTimer(account </span><span class="c4">string</span><span class="c8">, id uuid.UUID) Timer, error<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetTimers(account </span><span class="c4">string</span><span class="c8">) []Timer, error<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IncrementTimer(account </span><span class="c4">string</span><span class="c8">, id uuid.UUID) error<br> &nbsp; &nbsp; &nbsp;GetTimerExecutionCount(account </span><span class="c4">string</span><span class="c8">, id uuid.UUID) </span><span class="c4">int</span><span class="c8">, error<br>}<br><br></span><span class="c4">type</span><span class="c8">&nbsp;myDb </span><span class="c4">struct</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connPool *sql.DB<br>}<br><br></span><span class="c26">//global data access object</span><span class="c8"><br></span><span class="c4">var</span><span class="c8">&nbsp;DB DataAccess;<br><br></span><span class="c4">func</span><span class="c8">&nbsp;</span><span class="c9">InitDB</span><span class="c13">(address </span><span class="c4">string</span><span class="c13">)</span><span class="c8">&nbsp;</span><span class="c9">error</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4">var</span><span class="c8">&nbsp;db myDb<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c26">// ... initialize</span><span class="c8"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB = myDB<br>}<br><br></span><span class="c26">//implementation</span><span class="c8"><br></span><span class="c4">func</span><span class="c8">&nbsp;</span><span class="c13">(db myDb)</span><span class="c8">&nbsp;</span><span class="c9">InsertTimer</span><span class="c13">( ....</span></p></td></tr></tbody></table><h3 class="c6" id="h.9ndjqanaogc9"><span class="c19">Kafka (Server Side)</span></h3><p class="c0"><span>Kafka will be configured with log compaction. It will have one topic called timers that will have a fixed number of partitions, say 1000 for now. Since we&rsquo;re depending on Kafka for timer durability, meaning we return &ldquo;success&rdquo; responses to timer creation requests as soon as Kafka has a timer, we can also configure minimum ISR.</span></p><h3 class="c6" id="h.28jpsdqcm4hz"><span class="c19">Kafka Producer</span></h3><p class="c0"><span class="c3">When a request to create a timer is validated, it will be deterministically hashed into a partition by id, and the Producer will send it to Kafka in sync mode. The key for a timer will be uuid, and the value will be the serialized timer. </span></p><p class="c0"><span class="c3">A producer will send a record with key : uuid, value : null, to delete a timer. This will be cleaned up by log compaction. So it exposes the following interface.</span></p><p class="c0 c1"><span class="c3"></span></p><a id="t.0baa9423d42cf3e509b1230ad55948d577b1354a"></a><a id="t.5"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c4">type</span><span class="c8">&nbsp;Interface </span><span class="c4">interface</span><span class="c8">&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddTimer(Timer) error<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteTimer(uuid.UUID) error<br>}<br><br></span><span class="c4">struct</span><span class="c8">&nbsp;producer {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c26">// .... </span><span class="c8"><br>}<br><br></span><span class="c4">var</span><span class="c8">&nbsp;Access Interface<br><br></span><span class="c4">func</span><span class="c8">&nbsp;</span><span class="c9">InitProducer</span><span class="c13">(...)</span><span class="c8">&nbsp;error{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Access = producer{.../}<br>}</span></p></td></tr></tbody></table><h3 class="c6" id="h.pakq7lq0h3z6"><span>In Memory</span><span class="c19">&nbsp;Consumer Group</span></h3><p class="c0"><span class="c3">There will be a consumer group called &ldquo;memory_consumer&rdquo; that will be responsible for loading timers into memory that all nodes will be a member of. It&rsquo;s responsible for:</span></p><ul class="c18 lst-kix_t19fyvg3to46-0 start"><li class="c0 c2"><span class="c3">Partition balancing strategy (consistent hashing)</span></li></ul><ul class="c18 lst-kix_6oytfjqr8tn-0 start"><li class="c0 c2"><span class="c3">Loading/unloading timers into memory (handing to the schedule/executor)</span></li></ul><h4 class="c29" id="h.850ogodold1w"><span class="c31">Consistent Hashing</span></h4><p class="c0"><span class="c3">The problem we have to solve is given a list of memberIds and a list of partitions, assign each memberId a subset of the partitions. Consistent hashing is a good way to do this because when the members change, minimal timer reassignments have to happen. The algorithm is as follows:</span></p><ul class="c18 lst-kix_n7kl983wr31y-0 start"><li class="c0 c2"><span class="c3">Create some number, H, hashes of each memberId. ex: hash(memberId + &ldquo;.0&rdquo;), hash(memberId + &ldquo;.1&rdquo;) etc.</span></li><li class="c0 c2"><span class="c3">Mod those hashes by the number of partitions to assign each hash to a partition.</span></li><li class="c0 c2"><span class="c3">Put all these hashes (along with their associated memberId&rsquo;s and partitions) into a list.</span></li><li class="c0 c2"><span class="c3">Sort the list.</span></li><li class="c0 c2"><span class="c3">Every hash claims on behalf of its member every partition in the half open interval from its own partition to the partition of the hash to its right (looping around at the end).</span></li></ul><h4 class="c29" id="h.5vdo51qly1x4"><span class="c31">Loading timers into memory</span></h4><p class="c0"><span class="c3">Now, whenever there is a change of membership it will result in a change in responsibility. We can consider a node entering for the first time as transitioning to a view of membership in which they get no partitions to a view of membership in which they get some partitions. So the questions are:</span></p><ul class="c18 lst-kix_yn51mvm2vdo4-0 start"><li class="c0 c2"><span class="c3">What happens when I get a new partition?</span></li><li class="c0 c2"><span class="c3">What happens when I drop a partition?</span></li><li class="c0 c2"><span class="c3">What does regular consumption of a partition look like? </span></li></ul><p class="c0 c12 c1"><span class="c3"></span></p><p class="c0"><span class="c3">When getting a new partition, a timer will notify the Scheduler &ldquo;AddPartition&rdquo; method. They will also set the offset to zero so they can consume all timers. When they drop a partition, they will notify the Scheduler who will stop executing all those timers. </span></p><p class="c0 c12"><span class="c3">When regularly consuming a timer the key will be a uuid and the value will be either a timer or null. If it&rsquo;s a timer, they will check with the scheduler to see if it already exists in memory. If it doesn&rsquo;t exist in memory it will notify the Scheduler to add it. If it&rsquo;s null, it will notify the Scheduler to remove the timer if it exists.</span></p><h3 class="c6" id="h.6fel2koq3e3u"><span class="c19">Persistence Consumer Group</span></h3><p class="c0"><span class="c3">The persistence consumer group, called &ldquo;access_consumer&rdquo; can use any balancing strategy, (ie. the same node that consumes a timer for execution doesn&rsquo;t have to also persist it in the DB). It has two tasks:</span></p><ul class="c18 lst-kix_z4whsx5ofu7s-0 start"><li class="c0 c2"><span class="c3">Consume a timer creation record by persisting it in the DB</span></li><li class="c0 c2"><span class="c3">Consume a timer deletion record by deleting it from the DB</span></li><li class="c0 c2"><span class="c3">Consume a record that increments a timer to the DB</span></li></ul><p class="c0"><span class="c3">It will only consume a message once it gets verification from the database that the query was successful. This means that it&rsquo;s possible it dies after successfully submitting a query to the DB, but before confirming this with Kafka. That means we have to prepare for consuming the same message twice, so creating a timer will actually be &ldquo;create a timer if it doesn&rsquo;t already exist&rdquo; and delete a timer will be &ldquo;delete timer if it exists.&rdquo; In other words, these operations have to be idempotent. &nbsp;</span></p><h3 class="c6" id="h.cu70c0z17l8"><span class="c19">Scheduler/Executor</span></h3><p class="c0"><span class="c3">This file will expose four functions.</span></p><a id="t.f9b27b7d56ec948fb63a2aac433c69ca6b6dbc92"></a><a id="t.6"></a><table class="c5"><tbody><tr class="c24"><td class="c7" colspan="1" rowspan="1"><p class="c10"><span class="c8">AddTimer(t Timer) error<br><br>DeleteTimer(partition </span><span class="c4">uint32</span><span class="c8">, id uuid.UUID) error<br><br>HasTimer(id uuid.UUID) (</span><span class="c4">bool</span><span class="c8">, error)<br><br>AddPartition(partition, </span><span class="c4">uint32</span><span class="c8">) error<br><br>DeletePartition(partition, </span><span class="c4">uint32</span><span class="c8">) error</span></p></td></tr></tbody></table><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">A goroutine will be created for each timer. It will get a stop channel. Storage for the stop channels will look like this: </span></p><p class="c0"><span class="c4">map</span><span class="c8">[</span><span class="c4">uint32</span><span class="c8">]</span><span class="c4">map</span><span class="c8">[uuid.UUID]</span><span class="c4">chan&lt;-</span><span class="c8">&nbsp;</span><span class="c4 c17">int</span></p><p class="c0"><span class="c3">The purpose of this data structure is to allow a timer to get cancelled by partition and id.</span></p><p class="c0"><span>Timers will have to terminate on their own when they execute enough times. To do this they will just call the DeleteTimer function with their own partition and id.</span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">In terms of the actual goroutine, it will need three functions to operate.</span></p><ul class="c18 lst-kix_ln80o93high-0 start"><li class="c0 c2"><span class="c3">The task execution function</span></li><li class="c0 c2"><span class="c3">The scheduling function, that returns the next time the function needs to fire.</span></li><li class="c0 c2"><span class="c3">A function to call to increment execution count in the database.</span></li></ul><p class="c0"><span class="c3">The first two functions are provided by the Timer object itself, via the execution interface and the scheduler interface. The third one will be provided by the global data access object, which is safe for concurrent access. </span></p><p class="c0"><span class="c3">After every timer execution, the kafka producer will be queried to update a timer with the count.</span></p><p class="c0"><span class="c3">When executionCount is reached, the goroutine will query the kafka producer to remove the timer, and then terminate itself. </span></p><h3 class="c6" id="h.gcfhp9fvf1yi"><span class="c19">Summary (Folder Structure)</span></h3><ul class="c18 lst-kix_tydg66k0pc47-0 start"><li class="c0 c2"><span class="c3">tasktimer</span></li></ul><ul class="c18 lst-kix_tydg66k0pc47-1 start"><li class="c0 c28"><span class="c3">main.go (file)</span></li><li class="c0 c28"><span class="c3">internal</span></li></ul><ul class="c18 lst-kix_tydg66k0pc47-2 start"><li class="c0 c15"><span class="c3">services</span></li><li class="c0 c15"><span class="c3">routes</span></li><li class="c0 c15"><span class="c3">models</span></li></ul><ul class="c18 lst-kix_tydg66k0pc47-3 start"><li class="c0 c22"><span class="c3">timer</span></li><li class="c0 c22"><span class="c3">schedule</span></li><li class="c0 c22"><span class="c3">execution</span></li></ul><ul class="c18 lst-kix_tydg66k0pc47-2"><li class="c0 c15"><span class="c3">scheduler</span></li><li class="c0 c15"><span class="c3">dataAccess</span></li><li class="c0 c15"><span class="c3">producer</span></li><li class="c0 c15"><span class="c3">scheduleConsumer</span></li><li class="c0 c15"><span class="c3">accessConsumer</span></li></ul></body></html>